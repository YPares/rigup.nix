# Packaging Ruby Tools with Nix

Quick reference for packaging Ruby applications and gems as Nix derivations.

## Basic Application Packaging: bundlerApp

For Ruby executables intended as standalone tools, use `bundlerApp`:

```nix
{ bundlerApp }:

bundlerApp {
  pname = "my-ruby-tool";
  gemdir = ./.;  # Directory with Gemfile, Gemfile.lock, gemset.nix
  exes = [ "my-tool" ];  # List of executables to expose
}
```

`bundlerApp` creates a package that only exposes the listed executables, avoiding conflicts from common paths like `bin/rake` or `bin/bundler`.

## Using bundlerEnv

For development environments or when you need all gems available:

```nix
{ bundlerEnv, ruby }:

let
  gems = bundlerEnv {
    name = "my-project-gems";
    gemdir = ./.;
  };
in
mkShell {
  packages = [ gems gems.wrappedRuby ];
}
```

`bundlerEnv` is a wrapper over all gems in your gemset, making all `/lib` and `/bin` directories available.

**Note**: By default, only the `default` group is included. To include other groups:

```nix
bundlerEnv {
  name = "my-gems";
  gemdir = ./.;
  groups = [ "default" "development" "test" ];
}
```

## Generating gemset.nix with bundix

Ruby packaging in Nix requires a `gemset.nix` file generated from your `Gemfile.lock`:

```bash
# Install bundix
nix-shell -p bundix

# Generate gemset.nix
bundix
```

This creates `gemset.nix` alongside your `Gemfile` and `Gemfile.lock`.

## Directory Structure

Your Ruby project directory should contain:
```
my-ruby-tool/
├── Gemfile
├── Gemfile.lock
├── gemset.nix       # Generated by bundix
└── my-tool.rb       # or bin/my-tool
```

## Local Ruby Tool in a Riglet

Example of packaging a local Ruby script:

```nix
_:
{ pkgs, riglib, ... }: {
  config.riglets.my-riglet = {
    tools = [
      (pkgs.bundlerApp {
        pname = "my-tool";
        gemdir = ./scripts/my-tool;
        exes = [ "my-tool" ];
      })
    ];

    docs = riglib.writeFileTree {
      "SKILL.md" = ''
        # My Ruby Riglet

        Use `my-tool` to...
      '';
    };

    meta = {
      name = "My Ruby Riglet";
      description = "Provides my-tool for X";
    };
  };
}
```

## Packaging Individual Gems

For packaging a single gem (less common in riglets):

```nix
{ lib, bundlerApp, fetchFromGitHub }:

bundlerApp {
  pname = "jekyll";
  gemdir = ./.;
  exes = [ "jekyll" ];
}
```

## Alternative: ruby-nix

For modern reproducible Ruby environments, consider `ruby-nix`:

```bash
# Generate nix files from Gemfile.lock
nix run github:inscapist/ruby-nix -- lock
```

This generates `.nix-ruby` directory with all necessary Nix files.

## Ruby Versions

Specify Ruby version by using different Ruby packages:

```nix
bundlerApp.override { ruby = pkgs.ruby_3_3; }
```

Available: `ruby` (default), `ruby_3_3`, `ruby_3_2`, etc.

## Further Reading

- **Official nixpkgs Ruby documentation**: https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/ruby.section.md
- **Ruby language guide**: https://ryantm.github.io/nixpkgs/languages-frameworks/ruby/
- **NixOS Wiki - Packaging/Ruby**: https://nixos.wiki/wiki/Packaging/Ruby
- **bundix repository**: https://github.com/nix-community/bundix
- **ruby-nix (modern approach)**: https://github.com/inscapist/ruby-nix
- **Ruby development guide**: https://jamesmead.org/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell
